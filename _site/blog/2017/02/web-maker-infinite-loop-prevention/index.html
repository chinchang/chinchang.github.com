<!DOCTYPE HTML>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name=viewport content="width=device-width, initial-scale=1">
  <meta name="description" content="Code and Create" />
  <title>Web Maker: Preventing Infinite Loops - Kushagra Gour- Creativity freak!</title>
  
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
  


  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="/css/style.css?v=1" />

  
  <link rel="stylesheet" href="/css/prism.css" />
  <link rel="preconnect" href="https://fonts.gstatic.com/">

  <style>
    /* latin-ext */
      @font-face {
        font-family: 'PT Serif';
        font-style: normal;
        font-weight: 400;
        src: local('PT Serif'), local('PTSerif-Regular'), url(https://fonts.gstatic.com/s/ptserif/v9/EJRVQgYoZZY2vCFuvAFYzr-_dSb_nco.woff2) format('woff2');
        unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
      }
      /* latin */
      @font-face {
        font-family: 'PT Serif';
        font-style: normal;
        font-weight: 400;
        src: local('PT Serif'), local('PTSerif-Regular'), url(https://fonts.gstatic.com/s/ptserif/v9/EJRVQgYoZZY2vCFuvAFWzr-_dSb_.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }
      /* latin-ext */
      @font-face {
        font-family: 'PT Serif';
        font-style: normal;
        font-weight: 700;
        src: local('PT Serif Bold'), local('PTSerif-Bold'), url(https://fonts.gstatic.com/s/ptserif/v9/EJRSQgYoZZY2vCFuvAnt66qcVyvVp8NAyIw.woff2) format('woff2');
        unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
      }
      /* latin */
      @font-face {
        font-family: 'PT Serif';
        font-style: normal;
        font-weight: 700;
        src: local('PT Serif Bold'), local('PTSerif-Bold'), url(https://fonts.gstatic.com/s/ptserif/v9/EJRSQgYoZZY2vCFuvAnt66qSVyvVp8NA.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }

    </style>
  

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed/rss.xml">
  <script>
    /*var connectionCheckTimeout = setTimeout(function () {
        window.isSlowConnection = true;
        var style = document.createElement('style');
        style.textContent = 'body{font: 17px/1.56 -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"}';
        document.head.appendChild(style);
      }, 1000);
      window.onload = function () {
        console.log('fast connection');
        clearTimeout(connectionCheckTimeout);
      }*/
    </script>

</head>

<body class="blog">
  <a href="javascript:void(0)" title="or press '/' to search" onclick="toggleSearch()" class="search-btn">
    <svg style="width:48px;height:48px" viewBox="0 0 24 24">
      <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" />
    </svg>
  </a>

  <div class="search" id="js-search">
    <a href="javascript:void(0)" onclick="toggleSearch()" class="search__close-btn">
      <svg style="width:48px;height:48px" viewBox="0 0 24 24">
        <path d="M13.46,12L19,17.54V19H17.54L12,13.46L6.46,19H5V17.54L10.54,12L5,6.46V5H6.46L12,10.54L17.54,5H19V6.46L13.46,12Z" />
      </svg>
    </a>
    <input type="text" placeholder="Type here to search" class="search__input" id="js-search__input">
    <ul class="search__results" id="js-search__results"></ul>
  </div>

  <div id="outer-container">
    <div id="main-container">

      <header class="top-header ">


        <a class="top-header__link" href="/">
          <div id="me2" class="top-header__logo">
            <div></div>
          </div>
          <h1>Kushagra Gour</h1>
        </a>
        <h2>Game developer . Hacker . Creativity freak!</h2>
      </header>

      <nav>
  <ul>
    <li class="color-block"><a href="/games/" class="">
<svg viewBox="0 0 24 24">
    <path d="M7,6H17A6,6 0 0,1 23,12A6,6 0 0,1 17,18C15.22,18 13.63,17.23 12.53,16H11.47C10.37,17.23 8.78,18 7,18A6,6 0 0,1 1,12A6,6 0 0,1 7,6M6,9V11H4V13H6V15H8V13H10V11H8V9H6M15.5,12A1.5,1.5 0 0,0 14,13.5A1.5,1.5 0 0,0 15.5,15A1.5,1.5 0 0,0 17,13.5A1.5,1.5 0 0,0 15.5,12M18.5,9A1.5,1.5 0 0,0 17,10.5A1.5,1.5 0 0,0 18.5,12A1.5,1.5 0 0,0 20,10.5A1.5,1.5 0 0,0 18.5,9Z" />
</svg>
    games</a></li>

    <li class="color-block"><a href="/lab/" class="">
<svg viewBox="0 0 24 24">
    <path d="M6,22A3,3 0 0,1 3,19C3,18.4 3.18,17.84 3.5,17.37L9,7.81V6A1,1 0 0,1 8,5V4A2,2 0 0,1 10,2H14A2,2 0 0,1 16,4V5A1,1 0 0,1 15,6V7.81L20.5,17.37C20.82,17.84 21,18.4 21,19A3,3 0 0,1 18,22H6M5,19A1,1 0 0,0 6,20H18A1,1 0 0,0 19,19C19,18.79 18.93,18.59 18.82,18.43L16.53,14.47L14,17L8.93,11.93L5.18,18.43C5.07,18.59 5,18.79 5,19M13,10A1,1 0 0,0 12,11A1,1 0 0,0 13,12A1,1 0 0,0 14,11A1,1 0 0,0 13,10Z" />
</svg>
    lab</a></li>

    <li class="color-block"><a href="/blog/" class="">
<svg viewBox="0 0 24 24">
    <path d="M16.84,2.73C16.45,2.73 16.07,2.88 15.77,3.17L13.65,5.29L18.95,10.6L21.07,8.5C21.67,7.89 21.67,6.94 21.07,6.36L17.9,3.17C17.6,2.88 17.22,2.73 16.84,2.73M12.94,6L4.84,14.11L7.4,14.39L7.58,16.68L9.86,16.85L10.15,19.41L18.25,11.3M4.25,15.04L2.5,21.73L9.2,19.94L8.96,17.78L6.65,17.61L6.47,15.29" />
</svg>
    blog</a></li>

    <li class="color-block"><a href="http://draw.kushagragour.in" target="_blank">
<svg viewBox="0 0 24 24">
    <path d="M17.5,12A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 17.5,9A1.5,1.5 0 0,1 19,10.5A1.5,1.5 0 0,1 17.5,12M14.5,8A1.5,1.5 0 0,1 13,6.5A1.5,1.5 0 0,1 14.5,5A1.5,1.5 0 0,1 16,6.5A1.5,1.5 0 0,1 14.5,8M9.5,8A1.5,1.5 0 0,1 8,6.5A1.5,1.5 0 0,1 9.5,5A1.5,1.5 0 0,1 11,6.5A1.5,1.5 0 0,1 9.5,8M6.5,12A1.5,1.5 0 0,1 5,10.5A1.5,1.5 0 0,1 6.5,9A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 6.5,12M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21A1.5,1.5 0 0,0 13.5,19.5C13.5,19.11 13.35,18.76 13.11,18.5C12.88,18.23 12.73,17.88 12.73,17.5A1.5,1.5 0 0,1 14.23,16H16A5,5 0 0,0 21,11C21,6.58 16.97,3 12,3Z" />
</svg>
    draw</a></li>

    <li class="color-block"><a href="http://travel.kushagragour.in" target="_blank">
<svg viewBox="0 0 24 24">
    <path d="M11,23A2,2 0 0,1 9,21V19H15V21A2,2 0 0,1 13,23H11M12,1C12.71,1 13.39,1.09 14.05,1.26C15.22,2.83 16,5.71 16,9C16,11.28 15.62,13.37 15,16A2,2 0 0,1 13,18H11A2,2 0 0,1 9,16C8.38,13.37 8,11.28 8,9C8,5.71 8.78,2.83 9.95,1.26C10.61,1.09 11.29,1 12,1M20,8C20,11.18 18.15,15.92 15.46,17.21C16.41,15.39 17,11.83 17,9C17,6.17 16.41,3.61 15.46,1.79C18.15,3.08 20,4.82 20,8M4,8C4,4.82 5.85,3.08 8.54,1.79C7.59,3.61 7,6.17 7,9C7,11.83 7.59,15.39 8.54,17.21C5.85,15.92 4,11.18 4,8Z" />
</svg>
    travel</a></li>

    <li class="color-block"><a href="/about/" class="">
    <svg  viewBox="0 0 24 24">
    <path  d="M12,1C10.89,1 10,1.9 10,3C10,4.11 10.89,5 12,5C13.11,5 14,4.11 14,3A2,2 0 0,0 12,1M10,6C9.73,6 9.5,6.11 9.31,6.28H9.3L4,11.59L5.42,13L9,9.41V22H11V15H13V22H15V9.41L18.58,13L20,11.59L14.7,6.28C14.5,6.11 14.27,6 14,6" />
</svg>
    me</a></li>
  </ul>
  <div class="clear"></div>

</nav>


      <div id="content">
        <article>
	<h2 class="post-title">Web Maker: Preventing Infinite Loops</h2>
	<div class="post-meta">February 10, 2017</div>


	<div class="post-content"><h2>The Problem</h2>
<p>When you write JavaScript in <a href="https://kushagragour.in/lab/web-maker">Web Maker</a>, it renders that JavaScript inside the preview window in realtime. What this means is in case you using any loop structure in your code, there will probably be a point when you mid way defining your loop variables, conditions, variant etc. And at that point if Web Maker renders your JavaScript, it would result in an infinite loop. Lets see with an example. Suppose I want to write a for loop to iterate 10 times, I'll start with</p>
<pre><code class="language-javascript">
for (var i = 0; i<10; [cursor_here]) {
}
</code></pre>
<p>Note that my cursor would be where it says <code>[cursor_here]</code> and I am still defining my loop and going to write <code>i++</code> there. But as we render in realtime, this incomplete code would get executed in preview, resulting in an infinite loop.</p>
<p>Therefore we need a way to prevent such intermediate incomplete loops from running infinitely and choking the browser.</p>
<h2>Solution</h2>
<p>There is a <a href="http://mca.nowgray.com/2017/01/can-runtime-environment-detect-infinite.html">lot of discussion on the Web</a> regarding how difficult it is to detect an infinite loop in runtime, simply because any runtime cannot actually diffrentiate between a normal loop and one that is going to run infinitely. There are some analyzers that try to solve this issue but static analysis can only do so much.</p>
<p>The approach Web Maker takes to solve this is by keeping a check on the time spent inside a loop. To be specific, I check if the loop isn't taking more than 1 second. Otherwise its marked as an infinite loop. To be able to keep track of this time, we need to have a time check inside the loop and hence this requires changing the actual loop code, also called as <a href="https://en.wikipedia.org/wiki/Instrumentation_(computer_programming)">Code Instrumentation</a>.</p>
<p>So if we have a code like this:</p>
<pre><code class="language-javascript">
for ( var i = 0; i < 10;) {
}
</code></pre>
<p>After our instrumentation, it should change to:</p>
<pre><code class="language-javascript">
var startTime = Date.now();
for ( var i = 0; i < 10;) {
	if (Date.now() - startTime > 1000) { break; }
}
</code></pre>
<p>To analyze a piece of code, we need a JavaScript parser. I used <a href="http://esprima.org/">Esprima</a> for that. Lets see how we can use Esprima to instrument our code.</p>
<h3>Detecting a loop</h3>
<p>Esprima converts a string of JavaScript code into an <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">Abstract Syntax Tree</a> (AST), which is basically a tree like structure representing the code snippet.</p>
<pre><code class="language-javascript">
function instrumentCode(code) {
	var ast = esprima.parse(code);
}
</code></pre>
<p>To get a sense of what an AST looks like, lets run esprima on the following code:</p>
<pre><code class="language-javascript">
var foo = 3;
for (var i = 0; i < 10; i++) {}
</code></pre>
<p>This is what we'll get:</p>
<figure>
    <img src="/images/ast.png" alt="Esprima Abstract Syntax Tree" />
    <caption>Esprima's Abstract Syntax Tree</caption>
</figure>
<p>Notice how the return AST is a repeating nested array structure (<code>body</code> inside <code>body</code>), with each identifiable unit as an instance of some class. Eg. <code>VariableDeclaration</code>, <code>ForStatement</code> etc. This is something we can easily traverse using recursion, like so:</p>
<pre><code class="language-javascript">
function processAst(ast) {
	var currentElement;
	// If this ins't actual body, recurse with the body
	if (!Array.isArray(astBody)) {
		processAst(astBody.body);
		return;
	}
    // Traverse the body
    for (var i = ast.length; i--;) {
    	var currentElement = ast[i];

        // Process `currentElement` here

        // Recurse on inner body
        if (currentElement.body) {
            processAst(currentElement.body);
        }
    }
}
function instrumentCode(code) {
	var ast = esprima.parse(code);
    processAst(ast);
}
</code></pre>
<p>With the above code in place, we'll keep getting different syntax structures in <code>currentElement</code>. Next, we check them and inject the actual loop protection code.</p>
<h3>Injecting the loop protection checks</h3>
<p>We are concerned when <code>currentElement</code> is a <code>for</code>, <code>while</code> or <code>do-while</code> loop. This can be checked by simply testing <code>currentElement.type</code>. Lets add that.</p>
<pre><code class="language-javascript">
function processAst(ast) {
	var currentElement;
	// If this ins't actual body, recurse with the body
	if (!Array.isArray(astBody)) {
		processAst(astBody.body);
		return;
	}
    // Traverse the body
    for (var i = ast.length; i--;) {
    	var currentElement = ast[i];

        if (currentElement &&
        	currentElement.type === 'ForStatement' ||
            currentElement.type === 'WhileStatement' ||
            currentElement.type === 'DoWhileStatement') {
            // We got a loop!
        }
        // Recurse on inner body
        if (currentElement.body) {
        	processAst(currentElement.body);
        }
    }
}
</code></pre>
<p>Next we need two of our statements to be injected in AST syntax. For that we can again use esprima. Once we covert the statements into AST objects, its just a matter of adding them to the right <code>body</code> in our AST.</p>
<pre><code class="language-javascript">
if (currentElement &&
    currentElement.type === 'ForStatement' ||
    currentElement.type === 'WhileStatement' ||
    currentElement.type === 'DoWhileStatement') {

    var ast1 = esprima.parse('var myvar = Date.now();');
    var ast2 = esprima.parse('while(a){if (Date.now() - myvar > 1000) { break;}}');
    var insertionBlocks = {
        before: ast1.body[0],
        inside: ast2.body[0].body.body[0]
    };
}
</code></pre>
<p>Notice, that we have assigned the current time in <code>myVar</code>. Now there could be multiple loops (even nested) in a single code snippet and they all need to be handled with their unique variables. So we replace the variable names in our insertion blocks with a 3 digit random string:</p>
<pre><code class="language-javascript">
if (currentElement &&
    currentElement.type === 'ForStatement' ||
    currentElement.type === 'WhileStatement' ||
    currentElement.type === 'DoWhileStatement') {

    var ast1 = esprima.parse('var myvar = Date.now();');
    var ast2 = esprima.parse('while(a){if (Date.now() - myvar > 1000) { break;}}');
    var insertionBlocks = {
        before: ast1.body[0],
        inside: ast2.body[0].body.body[0]
    };
    randomVariableName = '_' + generateRandomId(3);
    insertionBLocks.before.declarations[0].id.name = insertionBLocks.inside.test.left.right.name = randomVariableName;
}
</code></pre>
<p>All that is left now is to insert the insertion blocks at right places:</p>
<pre><code class="language-javascript">
if (currentElement &&
    currentElement.type === 'ForStatement' ||
    currentElement.type === 'WhileStatement' ||
    currentElement.type === 'DoWhileStatement') {

    var ast1 = esprima.parse('var myvar = Date.now();');
    var ast2 = esprima.parse('while(a){if (Date.now() - myvar > 1000) { break;}}');
    var insertionBlocks = {
        before: ast1.body[0],
        inside: ast2.body[0].body.body[0]
    };
    randomVariableName = '_' + generateRandomId(3);
    insertionBLocks.before.declarations[0].id.name = insertionBLocks.inside.test.left.right.name = randomVariableName;

    // Insert time variable assignment as first child in the body array.
    ast.splice(i, 0, insertionBLocks.before);

    // If the loop's body is a single statement, then convert it into a block statement
    // so that we can insert our conditional break inside it.
    if (!Array.isArray(el.body)) {
    	currentElement.body = {
        	body: [ el.body ],
        	type: 'BlockStatement'
      	};
    }

    // Insert the `If` Statement check
    currentElement.body.body.unshift(insertionBLocks.inside);
}
</code></pre>
<p>And we are done.</p>
<p>You can also see the actual Web Maker <a href="https://github.com/chinchang/web-maker/blob/master/src/utils.js">source code for this logic</a>.</p>
</div>

	<div class="share-bar">
	

	<a href="http://twitter.com/share?url=/blog/2017/02/web-maker-infinite-loop-prevention/&text=&via=chinchang457&related=chinchang457">Tweet</a>
</div>
</article>

<div class="blog-navigation-buttons">
	

	
</div>

<div class="comment-box">
	<button id="showCommentsButton" style="margin:0 auto;display:block;" class="button" onclick="window.bootDisqus();">Show
		comments</button>
	<div id="disqusContainerEl" style="display: none">
		<h3>Comments</h3>
		<hr />
		<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'kushagragour';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    window.bootDisqus = function () {
        disqusContainerEl.style.display = 'block';
        showCommentsButton.style.display = 'none';
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    };
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	</div>
</div>

<div class="bring-to-top">TOP</div>
      </div>

    </div>
  </div>

  <footer>
    <section class="social-bar-2">

	<a class="social-bar-2__item  social-bar-2__item--twitter" href="https://twitter.com/chinchang457">
		<span class="social-bar-2__item__text">Twitter</span>
	</a>
	<a class="social-bar-2__item  social-bar-2__item--github" href="https://github.com/chinchang">
		<span class="social-bar-2__item__text">Github</span>
	</a>
	<a class="social-bar-2__item  social-bar-2__item--facebook" href="https://www.facebook.com/kgcodes">
		<span class="social-bar-2__item__text">Facebook</span>
	</a>

</section>


    Designed by <a href="http://twitter.com/chinchang457" target="_blank">Kushagra Gour</a> . Powered by <a href="https://11ty.io/"
        target="_blank">Eleventy</a> . Hosted on <a href="https://github.com/chinchang/chinchang.github.com" target="_blank">Github</a>
</footer>

  <script type="text/javascript">
if (location.host.indexOf('localhost') === -1) {

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-19798102-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

}
</script>

  <!--  -->
  
  <div class="fixed-link-box">
    <!-- Icon made by Austin Andrews from Flaticon.com -->
    <a href="/feed/feed.xml" class="rss-link" target="_blank"></a>
  </div>
  

  <script src="/js/script.js"></script>
</body>


</html>